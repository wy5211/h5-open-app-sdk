!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XMInstallSDK={})}(this,function(e){"use strict";function t(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})}function n(){const e=navigator.userAgent.toLowerCase();return e.includes("micromessenger")&&e.includes("miniprogram")}function o(){const e=navigator.userAgent.toLowerCase();return e.includes("micromessenger")&&!e.includes("miniprogram")}function i(){return n()||o()}function r(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function s(){return/android/i.test(navigator.userAgent)}"function"==typeof SuppressedError&&SuppressedError;class a extends Error{constructor(e,t,n){super(e),this.name="RequestError",this.response=t,this.data=n}}const c=e=>`${"undefined"!=typeof window?window.location.protocol:"https:"}//${e?"install.test.xmsharetalk.cn":"install.sharexm.com.cn"}`;let d=c(!1);function l(e){return t(this,void 0,void 0,function*(){const{url:t,method:n,data:o,headers:i={},timeout:r=1e4}=e,s=t.startsWith("http")?t:`${d}${t}`,c={method:n,headers:Object.assign({"Content-Type":"application/json"},i)};["POST","PUT","PATCH"].includes(n)&&o&&(c.body=JSON.stringify(o));const l=new AbortController,u=setTimeout(()=>l.abort(),r);try{const e=yield fetch(s,Object.assign(Object.assign({},c),{signal:l.signal}));let t;clearTimeout(u);const n=e.headers.get("content-type");if(t=n&&n.includes("application/json")?yield e.json():yield e.text(),!e.ok)throw new a(`HTTP Error: ${e.status} ${e.statusText}`,e,t);return t}catch(e){if(clearTimeout(u),e instanceof Error&&"AbortError"===e.name)throw new a(`Request timeout after ${r}ms`);if(e instanceof a)throw e;if(e instanceof Error)throw new a(`Network error: ${e.message}`);throw new a(`Network error: ${e.message||"Unknown error"}`)}})}function u(e,n,o){return t(this,void 0,void 0,function*(){return l(Object.assign({url:e,method:"POST",data:n},o))})}var p;!function(e){e.OpenTag="openTag",e.Scheme="scheme",e.Url="url"}(p||(p={}));const h="/api/sdk/v1";class f{setInitData(e){this.initData=e}getInitData(){return this.initData}constructor(){this.appBaseConfig=null,this.initData=void 0}static getInstance(){return f.instance||(f.instance=new f),f.instance}isSupportOpenTag(){return!!this.appBaseConfig&&this.appBaseConfig.types.includes(p.OpenTag)}set(e){this.appBaseConfig=e}get(e){return this.appBaseConfig?e?this.appBaseConfig[e]:this.appBaseConfig:null}}const w=f.getInstance();class g{constructor(){}static getInstance(){return g.instance||(g.instance=new g),g.instance}prepare(){return t(this,void 0,void 0,function*(){const e=w.get("open_tag");if(!e)throw console.warn("未找到微信开放标签配置"),new Error("未找到微信开放标签配置");const{js_sdk_url:t,js_sdk_config:n}=e;if(!t||!n)throw console.warn("缺少必要的微信JS-SDK配置信息",e),new Error("缺少必要的微信JS-SDK配置信息");try{return yield function(e){return"undefined"==typeof window||"undefined"==typeof document?Promise.reject(new Error("仅在浏览器环境中支持加载JS SDK")):new Promise((t,n)=>{const o=document.createElement("script");o.type="text/javascript",o.src=e,o.onload=()=>{t()},o.onerror=()=>{n(new Error(`加载脚本失败: ${e}`))},document.head.appendChild(o)})}(t),new Promise((e,t)=>{var o;if(window.wx){const{app_id:i,nonce_str:r}=n,s=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(n[o[i]]=e[o[i]])}return n}(n,["app_id","nonce_str"]),a=Object.assign(Object.assign({},s),{nonceStr:r,debug:(null===(o=w.getInitData())||void 0===o?void 0:o.isDebug)||!1,appId:i,openTagList:["wx-open-launch-app"],jsApiList:[]});window.wx.config(a);let c=!1,d=!1;window.wx.ready(()=>{d||c||(c=!0,console.log("微信JS-SDK配置成功"),e())}),window.wx.error(e=>{c||d||(d=!0,console.error("微信JS-SDK配置失败:",e,a),t(e))})}else t(new Error("微信JS-SDK加载失败"))})}catch(e){throw console.error("微信JS-SDK加载失败:",e),e}})}execute(){return t(this,void 0,void 0,function*(){console.log("微信开放标签策略，只需要通过 renderOpenTag 将微信开放标签成功渲染皆可")})}renderOpenTag(e,t){var n,o;e.innerHTML="";const i=w.get(),{open_tag:r}=i;if(!i)throw new Error("未找到微信开放标签配置，无法渲染");const{app_id:s}=r,a=document.createElement("wx-open-launch-app");a.setAttribute("appid",s),a.setAttribute("style","width: 100%; height: 100%;position: absolute; left: 0; top: 0"),(null===(n=w.getInitData())||void 0===n?void 0:n.ext_info)&&a.setAttribute("extinfo",(null===(o=w.getInitData())||void 0===o?void 0:o.ext_info)||""),a.innerHTML=`\n          <script type="text/wxtag-template">\n            ${t.template||"<div>打开APP</div>"}\n          <\/script>\n        `,a.addEventListener("launch",function(e){console.log("success",e)}),a.addEventListener("error",function(e){console.log("fail",e)}),e.appendChild(a)}canUse(){return!!(null===window||void 0===window?void 0:window.wx)&&(void 0!==window.wx&&!1!==window.wx.isReady)}}const v=g.getInstance();function m(e,t=500){setTimeout(e,t)}class y{constructor(){}static getInstance(){return y.instance||(y.instance=new y),y.instance}getIntranetIp(){return t(this,void 0,void 0,function*(){return new Promise(e=>{try{const t=new RTCPeerConnection({iceServers:[]});t.onicecandidate=function(t){if(!t||!t.candidate||!t.candidate.candidate)return;const n=t.candidate.candidate.split(" ");e(n[4])},t.createDataChannel(""),t.createOffer().then(e=>t.setLocalDescription(e)).catch(t=>{console.error(t),e("127.0.0.1")})}catch(t){console.error("获取内网IP失败",t),e("127.0.0.1")}})})}getExtranetIp(e){return t(this,void 0,void 0,function*(){try{const t=yield fetch("https://2025.ip138.com/"),n=yield t.text(),o=/target="_blank">([\d\.]+)<\/a>/,i=n.match(o);return i?i[1]:e}catch(t){return console.error("获取外网IP失败:",t),e}})}getBrandName(){const e=navigator.userAgent;if(/iPhone|iPad|iPod/i.test(e))return"Apple";const t=[{pattern:/SM-[A-Z0-9]+/i,brand:"Samsung"},{pattern:/Pixel/i,brand:"Google"},{pattern:/MI [0-9]+/i,brand:"Xiaomi"},{pattern:/Redmi/i,brand:"Redmi"},{pattern:/OPPO/i,brand:"OPPO"},{pattern:/VIVO/i,brand:"Vivo"},{pattern:/HUAWEI/i,brand:"Huawei"},{pattern:/Honor/i,brand:"Honor"},{pattern:/ONEPLUS/i,brand:"OnePlus"}];for(const{pattern:n,brand:o}of t)if(n.test(e))return o;return"Unknown"}getMobileModel(){const e=navigator.userAgent;if(/iPhone/i.test(e)){const t=[{pattern:/iPhone OS 17/,model:"iPhone 15 series"},{pattern:/iPhone OS 16/,model:"iPhone 14 series"},{pattern:/iPhone OS 15/,model:"iPhone 13 series"},{pattern:/iPhone OS 14/,model:"iPhone 12 series"},{pattern:/iPhone OS 13/,model:"iPhone 11 series"}];for(const{pattern:n,model:o}of t)if(n.test(e))return o;return"iPhone"}const t=e.match(/Android.*?; ([^;]+) Build/);return t?t[1].trim():"Unknown"}getWebGLInfo(){try{const e=document.createElement("canvas"),t=e.getContext("webgl2")||e.getContext("webgl")||e.getContext("experimental-webgl");if(!(t&&t instanceof WebGLRenderingContext))return{version:"WebGL not supported",gpu:"Unknown"};const n=t.getParameter(t.VERSION);let o="Unknown";const i=t.getExtension("WEBGL_debug_renderer_info");return i&&(o=t.getParameter(i.UNMASKED_RENDERER_WEBGL)||"Unknown"),{version:n,gpu:o}}catch(e){return console.warn("获取WebGL信息失败:",e),{version:"WebGL error",gpu:"Unknown"}}}getDownloadExtraInfo(){var e;return t(this,void 0,void 0,function*(){const t=this.getWebGLInfo(),n=yield this.getIntranetIp();return{download_type:r()?"ios":s()?"android":"pc",link_param:(null===(e=window.location.search.split("?"))||void 0===e?void 0:e[1])||"",screen_width:window.innerWidth,screen_height:window.innerHeight,device_pixel_ration:window.devicePixelRatio,web_gl_version:t.version,gpu_type:t.gpu,intranet_ip:n,extranet_ip:yield this.getExtranetIp(n),brand_name:this.getBrandName(),mobile_model:this.getMobileModel(),app_version:w.get("app_version")}})}execute(){var e;return t(this,void 0,void 0,function*(){const n=null===(e=w.getInitData())||void 0===e?void 0:e.id;if(!n)throw new Error("App ID is not set");const o=yield this.getDownloadExtraInfo(),i=yield function(e){return t(this,void 0,void 0,function*(){try{return(yield u(`${h}/download`,e)).data}catch(e){throw console.error("下载应用失败:",e),e}})}({app_id:n,ext_info:Object.assign({project_unique_id:n},o)}),{scheme:r,url:s}=i;if(/MicroMessenger/i.test(navigator.userAgent)&&s)window.location.href=s;else{if(r){const e=document.createElement("iframe");return e.style.display="none",e.src=r,document.body.appendChild(e),void m(s?()=>{document.body.removeChild(e),window.location.href=s}:()=>{document.body.contains(e)&&document.body.removeChild(e)},2e3)}s&&(window.location.href=s)}})}}const b=y.getInstance();const x=new class{constructor(){this.initialized=!1,this.options=null}init(e){return t(this,void 0,void 0,function*(){if(!(null==e?void 0:e.id))throw new Error("XMInstallSDK 未配置应用ID");this.options=e,console.log("XMInstallSDK initialized with options:",this.options),function(e=!1){d=c(e)}(e.isDebug),w.setInitData(e);try{yield this.fetchRemoteConfig(),yield this.executeWxStrategyPrepare(),this.initialized=!0}catch(e){throw console.error("XMInstallSDK 初始化失败:",e),e}})}checkInitialized(){if(!this.initialized)throw new Error("XMInstallSDK未初始化，请先调用init方法")}openApp(){this.checkInitialized();try{b.execute()}catch(e){throw console.error("XMInstallSDK 打开App失败:",e),e}}fetchRemoteConfig(){var e;return t(this,void 0,void 0,function*(){if(!(null===(e=this.options)||void 0===e?void 0:e.id))throw new Error("未配置应用ID，无法获取远程配置");try{const e=yield function(e){return t(this,void 0,void 0,function*(){try{return(yield u(`${h}/baseConfig`,e)).data}catch(e){throw console.error("获取应用配置失败:",e),e}})}({app_id:this.options.id,url:window.location.href});w.set(e),console.log("成功获取远程配置:",e)}catch(e){throw console.error("获取远程配置失败:",e),e}})}canUseWxOpen(){return v.canUse()}executeWxStrategyPrepare(){return t(this,void 0,void 0,function*(){if(i()&&w.isSupportOpenTag())try{yield v.prepare()}catch(e){console.error("微信策略执行失败:",e),window.wx=null}})}renderWxOpenTag(e,t){this.checkInitialized(),v.renderOpenTag(e,t)}};"undefined"!=typeof window&&(window.XMInstallSDK=x),e.default=x,e.isAndroid=s,e.isIOS=r,e.isMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},e.isWeChat=n,e.isWeChatEnv=i,e.isWeChatWebview=o,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
